<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="風止渚のホームページ">
        <meta name="author" content="風止渚">
        <title>風止渚のホームページ</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/style.css">
        <script src="/script.js" defer></script>
    </head>
    <body>
        <header id="header-placeholder"></header>
        <main>
            <h1>3Dグラフィックプログラムを作るまで (第1回)</h1>
            <p>Scratchって2Dグラフィックには強いけど3Dグラフィックは全く出来ませんよね？そこで、3Dグラフィックを作るためのプログラムを作ることにしました。</p>
            <p>第1回はまず、前提条件から考えていきます。最低限必要なプログラム等を洗い出し実装していきます。</p>
            <h2>前提条件</h2>
            <ul>
                <li>使用言語はScratch</li>
                <li>Scratch内の機能のみを使う(軽量化のためのTurboWarpは許容)</li>
                <li>他者の作品は使わない</li>
                <li>素晴らしい3Dグラフィックを作る</li>
            </ul>
            <p>以上の4つが前提条件です。特に3つ目の「他者の作品は使わない」というのは、私自身が技術を学ぶためにこうします。</p>
            <p>次にどういうふうにするか考えていきます。</p>
            <h2>実装方法</h2>
            <p>3Dグラフィックを作るには、3D空間を2D空間に投影する必要があります。そこで、まずは3D空間を2D空間に投影する方法を考えます。</p>
            <p>3D空間を2D空間に投影する方法として、透視投影と平行投影があります。透視投影は、遠くの物体が小さく見えるようにする方法で、平行投影は、物体の大きさが変わらないようにする方法です。今回は、透視投影を採用します。</p>
            <p>透視投影を実現するためには、視点からの距離に応じて物体の大きさを変化させる必要があります。具体的には、物体のZ座標を考慮して、X座標とY座標を適切にスケーリングします。</p>
            <p>これは次の式によって表されます。</p>
            <p>d = (W / 2) / tan(FOV / 2)</p>
            <p>x' = (x * d) / z</p>
            <p>y' = (y * d) / z</p>
            <p>ここで、dはカメラの焦点距離、Wはスクリーンの幅、FOVは視野角、(x, y, z)は3D空間の座標、(x', y')は2D空間の座標です。</p>
            <p>次にポリゴンについて考えます。ポリゴンは、3D空間の中で3つの頂点を持つ図形です。これらの頂点は、3D空間の座標(x1, y1, z1)、(x2, y2, z2)、(x3, y3, z3)で表されます。</p>
            <p>これらの頂点を先ほどの透視投影の式に代入して、2D空間の座標(x1', y1')、(x2', y2')、(x3', y3')を求めます。</p>
            <p>次の画像のようなプログラムになります。</p>
            <img src="./img/block_2025_9_16-0_49_51-2.avif" alt="透視プログラムの部分" class="screenshot">
            <p>このプログラムでは、1ポリゴンの座標データと色情報を元に、透視投影を行いポリゴン描画用のtrifillに透視投影された座標を渡しています。</p>
            <p>配列3D2Dの1番目は上の式のdに対応します。240は画面幅の1/2です。</p>
            <p>dの計算のあとのif文は、zが0より大きい場合のみ透視投影を行うためのものです。これにより、カメラの前にある物体だけが描画されるようになります。</p>
            <p>次にポリゴン描画のtrifillについて考えます。trifillは3角形を描画するもので、3つの頂点を持つポリゴンを描画するための関数です。</p>
            <p>trifillは3つの頂点の座標と色情報を受け取り、3角形を描画します。これにより、3D空間のポリゴンが2D空間に描画されます。</p>
            <p>trifillはたくさんの描画方法がありますが...私は高速にできるアルゴリズムを採用します。ただこの方法は自由が効かないですが...</p>
            <p>高速に描画するには効率よくポリゴンを塗りつぶしする必要があります。</p>
            <p>スキャンライン法とかがよく使われますが品質が若干悪い上に遅いです。そこで、より高速な描画方法を模索する必要があります。</p>
            <p>まずScratchのPENについて考えましょう。</p>
            <p>ScratchのPENは角丸の直線を引くことが出来ます。</p>
            <p>この角丸をいかにうまく利用するかが高速な3角形描画のポイントです。</p>
            <p>例えば、3角形の中心部分は太い線というか点で1回で塗りつぶすことでScratch側の負荷を軽減し効率よく描画することができます。</p>
            <p>当然、3角形の外周部分は細い線で描画する必要があります。</p>
            <p>改良アルゴリズムにより、約4段階の線の描画で効率よくポリゴンを塗りつぶすことが可能になります。</p>
        </main>
        <footer id="footer-placeholder"></footer>
    </body>
</html>